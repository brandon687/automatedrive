// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// Users/Submitters
model Submitter {
  id        String   @id @default(uuid())
  email     String?
  phone     String?
  name      String?
  createdAt DateTime @default(now()) @map("created_at")

  submissions Submission[]
  referrals   Referral[]   @relation("Referrer")
  referredBy  Referral[]   @relation("Referee")

  @@map("submitters")
}

// Vehicle Submissions (Tickets)
model Submission {
  id           String   @id @default(uuid())
  ticketNumber String   @unique @map("ticket_number")
  submitterId  String?  @map("submitter_id")
  submitter    Submitter? @relation(fields: [submitterId], references: [id])

  // Vehicle Info
  vin      String
  year     Int?
  make     String?
  model    String?
  trim     String?
  mileage  Int

  // Decoded VIN Data (JSON)
  vehicleSpecs Json? @map("vehicle_specs")

  // Market Valuation Data
  estimatedValueLow    Int?      @map("estimated_value_low")
  estimatedValueAvg    Int?      @map("estimated_value_avg")
  estimatedValueHigh   Int?      @map("estimated_value_high")
  valuationSource      String?   @map("valuation_source") // 'auto.dev', 'vincario', 'estimated', etc.
  valuationConfidence  String?   @map("valuation_confidence") // 'high', 'medium', 'low', 'none'
  valuationDate        DateTime? @map("valuation_date")
  pricingInsights      String?   @map("pricing_insights") // JSON string with detailed insights

  // Status
  status String @default("pending") // pending, forwarded, quoted, closed

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  media     Media[]
  quotes    Quote[]
  referrals Referral[]

  @@map("submissions")
}

// Media Files
model Media {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  type     String // front, rear, driver_side, passenger_side, steering_wheel, front_seat, back_seat, video
  filePath String @map("file_path")
  fileSize Int?   @map("file_size")
  mimeType String? @map("mime_type")

  uploadedAt DateTime @default(now()) @map("uploaded_at")

  @@map("media")
}

// Dealer Partners
model Dealer {
  id       String  @id @default(uuid())
  name     String
  email    String
  phone    String?
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")

  quotes Quote[]

  @@map("dealers")
}

// Quotes from Dealers
model Quote {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  submission   Submission @relation(fields: [submissionId], references: [id])
  dealerId     String   @map("dealer_id")
  dealer       Dealer   @relation(fields: [dealerId], references: [id])

  amount    Decimal
  notes     String?
  status    String   @default("pending") // pending, accepted, rejected

  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at")

  @@map("quotes")
}

// Referral Tracking
model Referral {
  id           String   @id @default(uuid())
  referrerId   String   @map("referrer_id")
  referrer     Submitter @relation("Referrer", fields: [referrerId], references: [id])
  refereeId    String   @map("referee_id")
  referee      Submitter @relation("Referee", fields: [refereeId], references: [id])
  submissionId String?  @map("submission_id")
  submission   Submission? @relation(fields: [submissionId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("referrals")
}
