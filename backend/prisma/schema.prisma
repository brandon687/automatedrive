// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Users/Submitters
model Submitter {
  id        String   @id @default(uuid())
  email     String?
  phone     String?
  name      String?
  createdAt DateTime @default(now()) @map("created_at")

  submissions Submission[]
  referrals   Referral[]   @relation("Referrer")
  referredBy  Referral[]   @relation("Referee")

  @@map("submitters")
}

// Vehicle Submissions (Tickets)
model Submission {
  id           String   @id @default(uuid())
  ticketNumber String   @unique @map("ticket_number")
  submitterId  String?  @map("submitter_id")
  submitter    Submitter? @relation(fields: [submitterId], references: [id])

  // Vehicle Info
  vin      String
  year     Int?
  make     String?
  model    String?
  trim     String?
  mileage  Int

  // Decoded VIN Data (JSON)
  vehicleSpecs Json? @map("vehicle_specs")

  // Market Valuation Data
  estimatedValueLow    Int?      @map("estimated_value_low")
  estimatedValueAvg    Int?      @map("estimated_value_avg")
  estimatedValueHigh   Int?      @map("estimated_value_high")
  valuationSource      String?   @map("valuation_source") // 'auto.dev', 'vincario', 'estimated', etc.
  valuationConfidence  String?   @map("valuation_confidence") // 'high', 'medium', 'low', 'none'
  valuationDate        DateTime? @map("valuation_date")
  pricingInsights      String?   @map("pricing_insights") // JSON string with detailed insights

  // Status
  status String @default("pending") // pending, forwarded, quoted, closed

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  media                Media[]
  quotes               Quote[]
  referrals            Referral[]
  marketPriceSources   MarketPriceSource[]
  marketAnalysis       MarketAnalysis?
  priceHistory         PriceHistory[]
  comparableVehicles   ComparableVehicle[]
  marketResearchJobs   MarketResearchJob[]

  @@map("submissions")
}

// Media Files
model Media {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  type     String // front, rear, driver_side, passenger_side, steering_wheel, front_seat, back_seat, video
  filePath String @map("file_path")
  fileSize Int?   @map("file_size")
  mimeType String? @map("mime_type")

  uploadedAt DateTime @default(now()) @map("uploaded_at")

  @@map("media")
}

// Dealer Partners
model Dealer {
  id       String  @id @default(uuid())
  name     String
  email    String
  phone    String?
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")

  quotes Quote[]

  @@map("dealers")
}

// Quotes from Dealers
model Quote {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  submission   Submission @relation(fields: [submissionId], references: [id])
  dealerId     String   @map("dealer_id")
  dealer       Dealer   @relation(fields: [dealerId], references: [id])

  amount    Decimal
  notes     String?
  status    String   @default("pending") // pending, accepted, rejected

  createdAt DateTime  @default(now()) @map("created_at")
  expiresAt DateTime? @map("expires_at")

  @@map("quotes")
}

// Referral Tracking
model Referral {
  id           String   @id @default(uuid())
  referrerId   String   @map("referrer_id")
  referrer     Submitter @relation("Referrer", fields: [referrerId], references: [id])
  refereeId    String   @map("referee_id")
  referee      Submitter @relation("Referee", fields: [refereeId], references: [id])
  submissionId String?  @map("submission_id")
  submission   Submission? @relation(fields: [submissionId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@map("referrals")
}

// ========================================
// MARKET RESEARCH & PRICING MODELS
// ========================================

// Individual price data from each market source
model MarketPriceSource {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // Source Information
  sourceName   String   @map("source_name") // 'cargurus', 'autotrader', 'kbb', 'nada', 'blackbook', 'edmunds'
  sourceUrl    String?  @map("source_url")

  // Pricing Data
  askingPrice        Int?     @map("asking_price")
  dealerPrice        Int?     @map("dealer_price")
  privatePartyPrice  Int?     @map("private_party_price")
  tradeInValue       Int?     @map("trade_in_value")

  // Listing Details
  listingId       String? @map("listing_id")
  dealerName      String? @map("dealer_name")
  dealerLocation  String? @map("dealer_location")
  mileage         Int?
  year            Int?
  condition       String?
  daysOnMarket    Int?    @map("days_on_market")

  // Vehicle-Specific Adjustments
  colorExterior String? @map("color_exterior")
  colorInterior String? @map("color_interior")
  transmission  String?
  drivetrain    String?
  fuelType      String? @map("fuel_type")

  // Confidence & Metadata
  confidenceScore  Float? @map("confidence_score")
  dataFreshness    DateTime @default(now()) @map("data_freshness")
  scrapeTimestamp  DateTime @default(now()) @map("scrape_timestamp")

  // Raw Data Storage
  rawData Json? @map("raw_data")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([submissionId])
  @@index([sourceName])
  @@index([dataFreshness])
  @@map("market_price_sources")
}

// Aggregated market analysis
model MarketAnalysis {
  id           String   @id @default(uuid())
  submissionId String   @unique @map("submission_id")
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // Aggregated Pricing (from multiple sources)
  marketLow                 Int    @map("market_low")
  marketAverage             Int    @map("market_average")
  marketHigh                Int    @map("market_high")
  recommendedAskingPrice    Int?   @map("recommended_asking_price")
  recommendedDealerOffer    Int?   @map("recommended_dealer_offer")

  // Market Intelligence
  totalComparableListings Int     @default(0) @map("total_comparable_listings")
  averageDaysToSell       Int?    @map("average_days_to_sell")
  marketDemand            String? @map("market_demand") // 'very_high', 'high', 'moderate', 'low', 'very_low'
  priceTrend              String? @map("price_trend") // 'increasing', 'stable', 'decreasing'

  // Geographic Analysis
  localMarketListings     Int?     @map("local_market_listings")
  nationalMarketListings  Int?     @map("national_market_listings")
  regionalPriceVariance   Float? @map("regional_price_variance")

  // Confidence Metrics
  dataSourcesCount  Int      @default(0) @map("data_sources_count")
  overallConfidence String?  @map("overall_confidence") // 'excellent', 'good', 'fair', 'poor'
  lastUpdated       DateTime @default(now()) @map("last_updated")

  // Analysis Notes
  marketInsights         String? @map("market_insights")
  pricingRecommendation  String? @map("pricing_recommendation")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([submissionId])
  @@index([lastUpdated])
  @@map("market_analysis")
}

// Historical price tracking
model PriceHistory {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // Price Point
  marketAverage Int @map("market_average")
  sourceCount   Int @map("source_count")

  // Snapshot timestamp
  recordedAt DateTime @default(now()) @map("recorded_at")

  // Change from previous
  changeAmount     Int?     @map("change_amount")
  changePercentage Float? @map("change_percentage")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([submissionId])
  @@index([recordedAt])
  @@map("price_history")
}

// Comparable vehicles for context
model ComparableVehicle {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // Vehicle Identity
  vin   String?
  year  Int
  make  String
  model String
  trim  String?

  // Listing Details
  askingPrice Int    @map("asking_price")
  mileage     Int
  condition   String?
  location    String?

  // Source
  sourceName  String  @map("source_name")
  sourceUrl   String? @map("source_url")
  listingDate DateTime? @map("listing_date")

  // Similarity Score
  similarityScore Float @map("similarity_score")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([submissionId])
  @@index([similarityScore])
  @@map("comparable_vehicles")
}

// Market research jobs queue
model MarketResearchJob {
  id           String   @id @default(uuid())
  submissionId String   @map("submission_id")
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  // Job Configuration
  jobType  String @map("job_type") // 'full_research', 'quick_check', 'price_update'
  priority Int    @default(5) // 1-10, higher = more urgent

  // Status
  status      String    @default("pending") // 'pending', 'processing', 'completed', 'failed'
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")

  // Results
  sourcesChecked    String @map("sources_checked") // JSON string array
  sourcesSuccessful String @map("sources_successful") // JSON string array
  errorMessage      String?  @map("error_message")

  // Retry Logic
  retryCount Int @default(0) @map("retry_count")
  maxRetries Int @default(3) @map("max_retries")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@index([priority])
  @@map("market_research_jobs")
}
